{% extends 'base_test.html' %}
{% load i18n %}


{% block content %}
    <div class="col-md-12">
    <div class="portlet box red">
        <div class="portlet-title">
            <div class="caption">
                <i class="fa fa-reorder"></i> Sign Up
            </div>
        </div>
        <div class="portlet-body form">
            <form class="horizontal-form" id="user_form" method="post" action="/usermodule/register/"
                  enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ user_form.username.id_for_label }}">Username:</label>
                                <input type="text" name="{{ user_form.username.name }}" class="form-control" required>
                                <span class="help-block">{{ user_form.username.errors.as_text }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ user_form.first_name.id_for_label }}">Firstname:</label>
                                <input type="text" name="{{ user_form.first_name.name }}" class="form-control" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ user_form.last_name.id_for_label }}">Lastname:</label>
                                <input type="text" name="{{ user_form.last_name.name }}" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ user_form.email.id_for_label }}">Email:</label>

                                <input type="email" name="{{ user_form.email.name }}" class="form-control" required>
                                <span class="help-block">{{ user_form.email.errors.as_text }}</span>

                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ user_form.password.id_for_label }}">Password:</label>
                                <input type="password" name="{{ user_form.password.name }}" class="form-control"
                                       required>
                                <span class="help-block">{{ user_form.password.errors.as_text }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ user_form.password_repeat.id_for_label }}">Confirm Password:</label>
                                <input type="password" name="{{ user_form.password_repeat.name }}" class="form-control"
                                       required>
                                <span class="help-block">{{ user_form.password_repeat.errors.as_text }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="row" hidden>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class=""></label>
                                <div class="checkbox-list">
                                    <label>
                                        <input name="{{ profile_form.admin.name }}" type="checkbox" checked> Make This
                                        User Admin
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ profile_form.employee_id.id_for_label }}">Employee Id:</label>
                                <input type="text" name="{{ profile_form.employee_id.name }}" class="form-control"
                                       value="123">
                                <span class="help-block">{{ profile_form.employee_id.errors.as_text }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row" hidden>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Organisation name:</label>
                                <select id="{{ profile_form.organisation_name.id_for_label }}"
                                        name="{{ profile_form.organisation_name.name }}" class="form-control">
                                    <option value="397" selected>Sajida Foundation</option>
                                    {#                                    {% for m,n in profile_form.fields.organisation_name.choices %}#}
                                    {#                                    <option value="{{ m }}">{{ n }}#}
                                    {#                                    </option>#}
                                    {#                                    {% endfor %}#}
                                </select>
                                <span class="help-block">{{ profile_form.organisation_name.errors.as_text }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Country:</label>
                                <select id="{{ profile_form.country.id_for_label }}"
                                        name="{{ profile_form.country.name }}" class="form-control">
                                    <option value="BGD" selected>Bangladesh</option>
                                    {#                                    {% for x,y in profile_form.fields.country.choices %}#}
                                    {#                                    <option value="{{ x }}">{{ y }}#}
                                    {#                                    </option>#}
                                    {#                                    {% endfor %}#}
                                </select>
                                <span class="help-block">{{ profile_form.country.errors.as_text }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row" hidden>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ profile_form.position.id_for_label }}" hidden>Position:</label>
                                <input type="hidden" name="{{ profile_form.position.name }}" class="form-control"
                                       value="default">
                                <span class="help-block" hidden>{{ profile_form.position.errors.as_text }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="{{ profile_form.contact_number.id_for_label }}">Contact Number (e.g:
                                    01xxxxxxxxx):</label>
                                <input type="text" name="{{ profile_form.contact_number.name }}" class="form-control"
                                       pattern="^(?:\+88|01)?(?:\d{11}|\d{13})$" required>
                                <span class="help-block">{{ profile_form.contact_number.errors.as_text }}</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Status:</label>
                                <select id="{{ profile_form.status.id_for_label }}"
                                        name="{{ profile_form.status.name }}" class="form-control" required>
                                    {% for x,y in profile_form.fields.status.choices %}
                                        <option value="{{ x }}">{{ y }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <span class="help-block">{{ profile_form.status.errors.as_text }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        {#                        <div class="col-md-6">#}
                        {#                            <div class="form-group">#}
                        {#                                <label>Role:</label>#}
                        {#                                <select id="role_id"#}
                        {#                                        name="role_id" class="form-control" onclick="load_catch(this)" required>#}
                        {#                                    <option value="">Select One</option>#}
                        {#                                    {% for m,n in role %}#}
                        {#                                        <option value="{{ m }}">{{ n }}</option>#}
                        {#                                    {% endfor %}#}
                        {#                                </select>#}
                        {#                                <span class="help-block">{{ profile_form.status.errors.as_text }}</span>#}
                        {#                            </div>#}
                        {#                        </div>#}

                        {#                        <div class="col-md-6">#}
                        {#                            <label>Region</label>#}
                        {#                            <select name="region_id" class="ui fluid  search selection dropdown icon " multiple=""#}
                        {#                                    id="region_id" required>#}
                        {#                                <option value="">Region</option>#}
                        {#                                {% for x,y in region %}#}
                        {#                                    <option value="{{ x }}">{{ y }}</option>#}
                        {#                                {% endfor %}#}
                        {#                            </select>#}
                        {#                        </div>#}
                        {#                        <div class="col-md-6">#}
                        {#                            <label>Branch</label>#}
                        {#                            <select name="branch_id" class="ui fluid search selection dropdown icon" multiple=""#}
                        {#                                    id="branch_id" required>#}
                        {#                                <option value="">Branch</option>#}
                        {#                            </select>#}
                        {#                            <span style="color: #b94a48; " id="help">* This field is required</span>#}
                        {#                        </div>#}
                        {#                        <div class="col-md-6" style="margin-top: 20px">#}
                        {#                            <a id="button_bootstrap" class="btn btn-default">Center</a>#}
                        {#                        </div>#}
                        <div class="col-md-7" id="area">
                            <div class="form-group">
                                <label>Catchment Area:</label>
                                <div id="loading"></div>
                                <div id="tree"></div>
                            </div>
                        </div>
                                                <input type="hidden" id="result_set" name="result_set"/>
                                                <input type="hidden" id="indication" name="indication"/>
                        {#                        <input type="hidden" id="role_name" name="role_name"/>#}
                    </div>
                </div>

                {#                <input type="hidden" name="selected" id="selected">#}
                <div class="row">

                </div>

                <div class="form-actions">
                    <button type="submit" class="btn red pull-right" id="submit">Submit</button>
                    <button onclick="history.go(-1);" style="margin-right:10px;" type="button"
                            class="btn default pull-right">Cancel
                    </button>
                </div>
            </form>
        </div>

    </div>


    <!-- Trigger the modal with a button -->

    {#    <div id="alert_modal" class="modal fade">#}
    {#        <div class="modal-dialog">#}
    {#            <div class="modal-content">#}
    {#                <div class="modal-header">#}
    {#                    <button type="button" class="close" data-dismiss="modal"><span#}
    {#                            aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>#}
    {#                </div>#}
    {#                <div class="modal-body">#}
    {#                </div>#}
    {#                 <div class="modal-footer">#}
    {#                    <button type="button" id="close" class="btn btn-default" data-dismiss="modal">Close</button>#}
    {#                </div>#}
    {#            </div>#}
    {#        </div>#}
    {#    </div>#}

    <!-- Modal -->
    {#    <div id="modal_bootstrap" class="modal fade">#}
    {#        <div class="modal-dialog">#}
    {#            <div class="modal-content">#}
    {#                <div class="modal-header">#}
    {#                    <button type="button" class="close" data-dismiss="modal"><span#}
    {#                            aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>#}
    {#                    <h4 class="modal-title">Center</h4>#}
    {#                </div>#}
    {#                <div class="modal-body">#}
    {#                    <div class="row">#}
    {#                        <div class="col-sm-5ths ">#}
    {#                            <label class="container">One#}
    {#                                <input type="checkbox" name="ONE" checked="checked">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {##}
    {#                            <label class="container">Two#}
    {#                                <input type="checkbox" name="Two">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {##}
    {##}
    {#                        </div>#}
    {##}
    {#                        <div class="col-sm-5ths">#}
    {#                            <label class="container">Three#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {##}
    {#                            <label class="container">Four#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {#                        </div>#}
    {##}
    {#                        <div class="col-sm-5ths">#}
    {#                            <label class="container">Three#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {##}
    {#                            <label class="container">Four#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {#                        </div>#}
    {##}
    {#                        <div class="col-sm-5ths">#}
    {#                            <label class="container">Three#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {##}
    {#                            <label class="container">Four#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {#                        </div>#}
    {##}
    {#                        <div class="col-sm-5ths">#}
    {#                            <label class="container">Three#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {##}
    {#                            <label class="container">Four#}
    {#                                <input type="checkbox">#}
    {#                                <span class="checkmark"></span>#}
    {#                            </label>#}
    {#                        </div>#}
    {#                    </div>#}
    {##}
    {##}
    {#                </div>#}
    {#                <div class="modal-footer">#}
    {#                    <button type="button" id="close" class="btn btn-default" data-dismiss="modal">Close</button>#}
    {##}
    {#                </div>#}
    {#            </div>#}
    {#        </div>#}
    {#    </div>#}







{% endblock %}

{% block additional-javascript %}
    {#    <script src="{{STATIC_URL}}assets/plugins/jquery-1.10.2.min.js" type="text/javascript"></script>#}
    {#     <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>#}
    {#        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/js/bootstrap.min.js"></script>#}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gijgo/1.9.6/combined/js/gijgo.min.js"
            type="text/javascript"></script>
    <script src="{{ STATIC_URL }}js/alertify.js"
            type="text/javascript"></script>
    {#    <script type="text/javascript">#}
    {#        $.fn.bsModal = $.fn.modal.noConflict();#}
    {#    </script>#}
    {#    <script src="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.js"></script>#}

    <script>


        function load_catch(obj) {
            var selected_role = $('#role_id option:selected').text();
            $('#role_name').val($('#role_id option:selected').text());
            var roles = ["Community Organizer", "Sajida Bondhu", "Psychosocial Educator", "Law Officer"];
            if (roles.includes(selected_role)) {
                tree.uncheckAll();
                $('#area').show();
            }

            else $('#area').hide();

        }


        var datasource = {{ datasource| safe }}['list_of_dictionary'];
        var check_node_already_expanded = [];

        var tree = $('#tree').tree({
            primaryKey: 'id',
            uiLibrary: 'bootstrap',
            dataSource: datasource,
            checkboxes: true,
            cascadeCheck: false,
            lazyLoading: true
        });

        var indication = 0;
        var cnt = 0;

        tree.on('checkboxChange', function (e, $node, record, state) {
            if (state == "checked") {
                cnt++;


                {#                var for_branch_role = ["Community Organizer", "Psychosocial Educator", "Law Officer"];#}
                {#                var for_center_role = ["Sajida Bondhu"];#}
                var level = record['level'];
                {#                var get_seletecd_role = $('#role_id option:selected').text();#}


                if (level == "region") {
                    {#                    $('.modal-body').html("<h4>Do not Select Region. Select Either Branch or Center</h4>");#}
                    {#                    $('#alert_modal').show()#}
                    alertify.alert('', '<h4>Do not Select Region. Select Either Branch or Center</h4>').set({transition: 'zoom'}).show();
                    tree.uncheck($node);
                }
                else if (level == "branch") {
                    if (indication == 2) {
                        alertify.alert('', '<h4>Select Either Branches or Centers</h4>').set({transition: 'zoom'}).show();
                        tree.uncheckAll();
                        indication = 0;
                    }
                    else indication = 1;
                }
                else if (level == "center") {
                    if (indication == 1) {
                        alertify.alert('', '<h4>Select Either Branches or Centers</h4>').set({transition: 'zoom'}).show();
                        tree.uncheckAll();
                        indication = 0;
                    }
                    else indication = 2;
                }


                {#                else if (level == "branch") {#}
                {#                    if (for_center_role.includes(get_seletecd_role.toString())) {#}
                {#                        alertify.alert('', '<h4>Select Centers when role is ' + get_seletecd_role + '</h4>').set({transition:'zoom'}).show();#}
                {#                        tree.uncheck($node);#}
                {#                    }#}
                {#                }#}
                {#                else if (level == "center") {#}
                {#                    if (for_branch_role.includes(get_seletecd_role.toString())) {#}
                {#                        alertify.alert('', '<h4>Select Branches when role is ' + get_seletecd_role + '</h4>').set({transition:'zoom'}).show();#}
                {#                        tree.uncheck($node);#}
                {#                    }#}
                {#                }#}
            }

            if (state == "unchecked") {
                cnt--;
                if (cnt <= 0)
                    indication = 0;
            }


        });


        tree.on('expand', function (e, node, id) {
            node_name = tree.getDataById(id)['text'];


            if (check_node_already_expanded.includes(id)) {
                return;
            }
            else check_node_already_expanded.push(id);
            {#                console.log(check_node_already_expanded);#}
            ajaxcall();
            $.ajax({
                url: '/usermodule/add_children_branch/',
                type: 'POST',
                dataType: 'json',
                beforeSend: function () {
                    $('#loading').show();

                    $("#loading").html('<div class="ui active inverted dimmer">\n' +
                        '    <div class="ui text loader">Loading</div>\n' +
                        '  </div>');


                },
                data: {'id': id, 'node_name': node_name},
                success: function (result) {
                    $('#loading').hide(500);
                    {#                        $('.test').fadeIn(500);#}
                    for (each in result['list_of_dictionary'])
                        tree.addNode(result['list_of_dictionary'][each], node);

                    {#                        console.log(tree.getChildren(node));#}
                }
            });

        });


        {#        $('#close').on('click', function () {#}
        {#            var selected = [];#}
        {#            $('.modal-body input:checked').each(function () {#}
        {#                selected.push($(this).attr('name'));#}
        {#            });#}
        {#            $('#selected').val(JSON.stringify(selected));#}
        {#            console.log(JSON.stringify(selected))#}
        {#        })#}
        {##}
        {#        $("#button_bootstrap").on("click", function () {#}
        {#            $("#modal_bootstrap").bsModal("show");#}
        {#        });#}

        {#        $('#help').hide();#}

        {#        $('#region_id').dropdown(#}
        {#            {#}
        {#                onChange: function (value, text, $selectedItem) {#}
        {#                    load_branch(value);#}
        {#                }#}
        {#            }#}
        {#        );#}
        {#        $('#branch_id').dropdown();#}

        function intersect_safe(a, b) {
            var ai = 0, bi = 0;
            var result = new Array();

            while (ai < a.length && bi < b.length) {
                if (parseInt(a[ai]) != parseInt(b[bi])) {
                    bi++;
                }
                else if (parseInt(a[ai]) == parseInt(b[bi])) {
                    result.push(a[ai]);
                    ai++;
                    bi++;
                }
            }

            return result;
        }

        function load_branch(region_id) {
            ajaxcall();
            $('#branch_id').dropdown('restore defaults');
            if (region_id.length == 0) {
                $('#branch_id').html("<option value=\"\">SAOO Name</option>");
            }
            else {

                {#                    var branch_id = value_filter($('#branch_id').dropdown('get value'));#}

                $.ajax({
                    url: '/usermodule/getBranches/',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        'region_id': JSON.stringify(region_id),
                        {#                               'branch_id':JSON.stringify(branch_id) #}
                    },
                    success: function (result) {
                        var res = [];
                        var html_code = "<option value=\"\">Branch</option>";
                        for (i = 0; i < result.length; i++) {
                            html_code += "<option value=\"" + result[i].id + "\"> " + result[i].branch_name + "</option>";
                            {#                                if(result[i].id in branch_id)#}
                            res.push(result[i].id)
                        }
                        {#                            console.log(intersect_safe(branch_id,res));#}
                        $('#branch_id').html(html_code);

                    }
                });
            }
        }


        $('#submit').on("click", function () {
            {#            var branch_id = value_filter($('#branch_id').dropdown('get value'));#}
            {##}
            {#            if (branch_id[0] == null) {#}
            {#                $('#help').show();#}
            {#                return false;#}
            {#            }#}
            {#            else $('#help').hide();#}


            var result = "";
            result = result.concat(tree.getCheckedNodes().toString());
            {#                for (each in check_nodes) {#}
            {#                    result = result.concat(",");#}
            {#                    result = result.concat(String(check_nodes[each]));#}
            {#                }#}

            $('#result_set').val(result);

            $('#indication').val(indication);

        });


        function ajaxcall() {
            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    function getCookie(name) {
                        var cookieValue = null;
                        if (document.cookie && document.cookie != '') {
                            var cookies = document.cookie.split(';');
                            for (var i = 0; i < cookies.length; i++) {
                                var cookie = jQuery.trim(cookies[i]);
                                // Does this cookie string begin with the name we want?
                                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }

                    if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                        // Only send the token to relative URLs i.e. locally.
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                }
            });
        }


        function value_filter(some) {
            return some.slice(0, some.length - 1);
        }
    </script>

    <!-- <script type="text/javascript" src="/static/js/jquery.searchable-ie-1.1.0.min.js"></script> -->
    <!-- <script type="text/javascript" src="/static/js/usermodule_userprofile.js"></script>    -->

{% endblock %}

{% block additional-headers %}
    <head>
        <title>
            {% block title %} Register User {% endblock %}
        </title>
        {#<link rel="stylesheet" type="text/css" href="{{STATIC_URL}}assets/plugins/select2/select2_metro.css"/>#}
        {#<link rel="stylesheet" href="{{STATIC_URL}}assets/plugins/data-tables/DT_bootstrap.css"/>#}
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/semantic-ui/2.2.10/semantic.min.css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/gijgo/1.9.6/combined/css/gijgo.min.css" rel="stylesheet"
              type="text/css"/>
        <link rel="stylesheet" href="{{ STATIC_URL }}css/alertify.css">
    </head>
    <style>
        .col-sm-5ths {
            width: 20%;
            float: left;
            padding-left: 20px;
        }

        .data-table-container table {
            clear: both;
            display: table !important;
            overflow-x: auto;
            width: 98% !important;
        }

        .highlight {
            background-color: #D9EDF7;
        }

        .table th, .table td {
            border: 1px solid #dddddd !important;
        }

        tr:hover {
            background-color: #ffff99;
        }

        .container {
            display: block;
            position: relative;
            padding-left: 25px;
            margin-bottom: 12px;
            cursor: pointer;
            font-size: 15px;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Hide the browser's default checkbox */
        .container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        /* Create a custom checkbox */
        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 20px;
            width: 20px;
            background-color: #eee;
        }

        /* On mouse-over, add a grey background color */
        .container:hover input ~ .checkmark {
            background-color: #ccc;
        }

        /* When the checkbox is checked, add a blue background */
        .container input:checked ~ .checkmark {
            background-color: #2196F3;
        }

        /* Create the checkmark/indicator (hidden when not checked) */
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }

        /* Show the checkmark when checked */
        .container input:checked ~ .checkmark:after {
            display: block;
        }

        /* Style the checkmark/indicator */
        .container .checkmark:after {
            left: 9px;
            top: 5px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 3px 3px 0;
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            transform: rotate(45deg);
        }
    </style>

{% endblock %}
